name: Mutation Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual trigger
  schedule:
    # Run full mutation testing weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Fast mutation testing on high-coverage modules (runs on every push/PR)
  mutation-converters:
    name: Mutation Testing - ML Converters
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-mutants-${{ hashFiles('**/Cargo.lock') }}

    - name: Install cargo-mutants
      run: cargo install cargo-mutants --locked

    - name: Run mutation testing on ML converters
      run: |
        echo "ğŸ§¬ Running mutation testing on ML converters..."
        echo "Expected: 56 mutants, ~1 minute runtime"
        cargo mutants --file "src/*_converter.rs" --timeout 60 --jobs 4 --output mutants.out || true

    - name: Display mutation results
      run: |
        if [ -f mutants.out ]; then
          echo "ğŸ“Š Mutation Testing Results:"
          cat mutants.out
          echo ""

          # Extract key metrics
          CAUGHT=$(grep -o "[0-9]* caught" mutants.out | grep -o "[0-9]*" || echo "0")
          MISSED=$(grep -o "[0-9]* missed" mutants.out | grep -o "[0-9]*" || echo "0")
          UNVIABLE=$(grep -o "[0-9]* unviable" mutants.out | grep -o "[0-9]*" || echo "0")

          TOTAL_VIABLE=$((CAUGHT + MISSED))
          if [ $TOTAL_VIABLE -gt 0 ]; then
            SCORE=$((CAUGHT * 100 / TOTAL_VIABLE))
            echo "Mutation Score: $SCORE% ($CAUGHT/$TOTAL_VIABLE caught)"

            # Fail if score is below 80%
            if [ $SCORE -lt 80 ]; then
              echo "âŒ Mutation score below 80% threshold"
              exit 1
            else
              echo "âœ… Mutation score meets 80% threshold"
            fi
          fi
        fi

    - name: Upload mutation results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mutation-converters-results
        path: |
          mutants.out
          mutants.out.old
        retention-days: 30

  # Full mutation testing (runs weekly or manually)
  mutation-full:
    name: Full Mutation Testing
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 120

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-mutants-full-${{ hashFiles('**/Cargo.lock') }}

    - name: Install cargo-mutants
      run: cargo install cargo-mutants --locked

    - name: Run full mutation testing
      run: |
        echo "ğŸ§¬ Running full mutation testing suite..."
        echo "Expected: ~1015 mutants, extended runtime"
        cargo mutants --timeout 300 --jobs 4 --output mutants-full.out || true

    - name: Display full mutation results
      run: |
        if [ -f mutants-full.out ]; then
          echo "ğŸ“Š Full Mutation Testing Results:"
          cat mutants-full.out
          echo ""

          # Extract key metrics
          CAUGHT=$(grep -o "[0-9]* caught" mutants-full.out | grep -o "[0-9]*" || echo "0")
          MISSED=$(grep -o "[0-9]* missed" mutants-full.out | grep -o "[0-9]*" || echo "0")
          UNVIABLE=$(grep -o "[0-9]* unviable" mutants-full.out | grep -o "[0-9]*" || echo "0")

          TOTAL=$((CAUGHT + MISSED + UNVIABLE))
          TOTAL_VIABLE=$((CAUGHT + MISSED))

          echo "Total mutants: $TOTAL"
          echo "Viable mutants: $TOTAL_VIABLE"
          echo "Caught: $CAUGHT"
          echo "Missed: $MISSED"
          echo "Unviable: $UNVIABLE"

          if [ $TOTAL_VIABLE -gt 0 ]; then
            SCORE=$((CAUGHT * 100 / TOTAL_VIABLE))
            echo "Overall Mutation Score: $SCORE%"
          fi
        fi

    - name: Upload full mutation results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mutation-full-results
        path: |
          mutants-full.out
          mutants.out.old
        retention-days: 90

  mutation-success:
    name: Mutation Testing Success
    runs-on: ubuntu-latest
    needs: [mutation-converters]
    if: github.event_name != 'schedule'

    steps:
    - name: Mutation testing passed
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  âœ… Mutation Testing Passed                   â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ§¬ ML Converters: Mutation score â‰¥80%"
        echo "ğŸ“Š Test quality validated"
        echo ""
        echo "ğŸ’¡ Mutation testing validates that tests catch code changes"
        echo "   This goes beyond code coverage to measure test effectiveness"
